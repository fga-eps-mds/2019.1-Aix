dist: xenial

language: ruby

services:
  - docker

sudo: required
env:
  global:
    - CC_TEST_REPORTER_ID=${CC_TEST_REPORTER_ID}
notifications:
  webhooks: https://fathomless-fjord-24024.herokuapp.com/notify

jobs:
  include:
    - stage: Build
      name: Bot
      env: SERVICE_NAME=aix-bot
      script:
        # - git diff --name-only $TRAVIS_COMMIT_RANGE | grep -qE '^(bot\/|\.travis.yml|scripts\/)'  || exit 0
        - docker build -q -t aixchatbot/aix-bot -f ./docker/bot.Dockerfile .
        - docker run aixchatbot/aix-bot curl -L https://codeclimate.com/downloads/test-reporter/test-reporter-latest-linux-amd64 > /tests/cc-test-reporter
        - docker run aixchatbot/aix-bot chmod +x /tests/cc-test-reporter
        - docker run aixchatbot/aix-bot /tests/cc-test-reporter/cc-test-reporter before-build
        - docker run aixchatbot/aix-bot flake8 --filename=*.py --exclude='__pycache__, tests' --ignore=F821, F841
        - docker run aixchatbot/aix-bot pytest --cov-config=.coveragerc --cov=.
        - docker run aixchatbot/aix-bot /tests/cc-test-reporter/cc-test-reporter after-build --exit-code $TRAVIS_TEST_RESULT
      deploy:
        provider: script
        script: bash ./deploy.sh
        on:
          branch: master
    - stage: Build
      name: Actions
      env: SERVICE_NAME=aix-actions
      script:
        # - git diff --name-only $TRAVIS_COMMIT_RANGE | grep -qE '^(actions\/|\.travis.yml)'  || exit 0
        - docker build -q -t aixchatbot/aix-actions -f ./actions/actions.Dockerfile ./actions
        - docker run aixchatbot/aix-actions run curl -L https://codeclimate.com/downloads/test-reporter/test-reporter-latest-linux-amd64 > /tests/cc-test-reporter/cc-test-reporter
        - docker run aixchatbot/aix-actions run chmod +x /tests/cc-test-reporter/cc-test-reporter
        - docker run aixchatbot/aix-actions run /tests/cc-test-reporter/cc-test-reporter before-build
        - docker run aixchatbot/aix-actions run flake8 --filename=*.py --exclude='__pycache__, tests' actions
        - docker run aixchatbot/aix-actions run pytest --cov-config=.coveragerc --cov=.
        - docker run aixchatbot/aix-actions run /tests/cc-test-reporter/cc-test-reporter after-build --exit-code $TRAVIS_TEST_RESULT
      deploy:
        provider: script
        script: bash ./deploy.sh
        on:
         branch: master
